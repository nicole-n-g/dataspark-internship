from query_kdtree_v2 import *
import re

# Flattens an irregular list of lists
def flatten(l):
    basestring = (str, bytes)
    for el in l:
        if isinstance(el, collections.Sequence) and not isinstance(el, basestring):
            for sub in flatten(el):
                yield sub
        else:
            yield el
###########################################################
# Sentosa Express & Changi Airport Skytrain stations not included
mrt_lrt_letter_codes = ["EW", "NS", "CC", "DT", "NE", "CG", "CE", "BP", "SW", "PW", "SE", "PE"]

train_lines = ["East-West Line", "North-South Line", "North-East Line", "Circle Line", "Downtown Line", "Bukit Panjang Line","Sengkang Line (West Loop)", "Punggol Line (East Loop)", "Sengkang Line (East Loop)", "Punggol Line (West Loop)", "Sentosa Express", "LRT Changi Line"]

p = re.compile('[1-9][0-9]?;?')
q = re.compile('[0-9]+')

def identify_mrt_lrt_stations(tag):
    if tag[:3] == "ref":
        if tag[6:8] == "DT" and p.fullmatch(tag[8:10]) != None and int(tag[8:10]) >= 20:
            return False
        elif tag[6:8] in mrt_lrt_letter_codes and p.fullmatch(tag[8:10]) != None:
            return True
        # elif tag[6] == "S" and p.fullmatch(tag[-1]) != None:
        #     return True
    return False
    
def identify_mrt_lrt_lines(tag):
    if tag[:3] == "ref" and tag[6:] in train_lines:
        return True
    return False
###########################################################

def identify_bus_numbers(tag):
    if tag[:10] == "name = Svc":
        return True
    return False

###########################################################
highway_abbreviations = ["CTE", "PIE", "AYE", "ECP", "BKE", "TPE", "SLE", "KJE", "KPE", "MCE"]
highway_names = ["Central Expressway", "Pan-Island Expressway", "Ayer Rajah Expressway", "East Coast Parkway", "Bukit Timah Expressway", "Tampines Expressway", "Seletar Expressway", "Kranji Expressway", "Kallang-Paya Lebar Expressway", "Marina Coastal Expressway"]

def identify_expressways(tag):
    if tag[:3] == "ref" and tag[6:] in highway_abbreviations:
        return True
    elif tag[:4] == "name" and (tag[7:] in highway_abbreviations or tag[7:] in highway_names):
        return True
    return False
###########################################################
def classify_descriptions(sorted_description_counts):
    train_stations = []
    train_lines = []
    bus = []
    driving = []
    for tup in sorted_description_counts.copy():
        if identify_mrt_lrt_stations(tup[0]):
            train_stations.append(tup)
            sorted_description_counts.remove(tup)
        elif identify_mrt_lrt_lines(tup[0]):
            train_lines.append(tup)
            sorted_description_counts.remove(tup)
        elif identify_bus_numbers(tup[0]):
            bus.append(tup)
            sorted_description_counts.remove(tup)
        elif identify_expressways(tup[0]):
            driving.append(tup)
            sorted_description_counts.remove(tup)
        elif tup[0][:3] == "ref" and q.fullmatch(tup[0][6:]):
            sorted_description_counts.remove(tup)
    return [train_stations, train_lines, bus, driving, sorted_description_counts]

###########################################################
def get_infrastructure_by_time(keyword_tags, all_nearest_nodes_descriptions, timestamps):
    for i in range(len(all_nearest_nodes_descriptions)):
        relevant_tags = list(filter(lambda x: x in keyword_tags, all_nearest_nodes_descriptions[i]))
        relevant_tags.sort()
        timestamps[i] = [timestamps[i], relevant_tags]
    return timestamps

##################### Main Function Run ##########################
if __name__== "__main__":
    #ACF 14
    route_lst = [['2016-03-14 07:06', '1.3233600223081028', '103.76461889594793', '0', 'core'], ['2016-03-14 07:08', '1.3180506592921482', '103.76874078065157', '0', 'non-core'], ['2016-03-14 07:14', '1.3133589248117155', '103.76519858837128', '-1', 'non-core'], ['2016-03-14 07:15', '1.313254047845004', '103.77396080642939', '-1', 'non-core'], ['2016-03-14 07:16', '1.3107311125736218', '103.77748650631735', '-1', 'non-core'], ['2016-03-14 07:17', '1.3093012459868503', '103.78272084519267', '-1', 'non-core'], ['2016-03-14 07:18', '1.3083076183772913', '103.78953393548727', '-1', 'non-core'], ['2016-03-14 07:19', '1.306826212158573', '103.79145031794906', '-1', 'non-core'], ['2016-03-14 07:20', '1.3051378657857153', '103.79872865974903', '-1', 'non-core'], ['2016-03-14 07:21', '1.3005383429708492', '103.80110658418674', '-1', 'non-core'], ['2016-03-14 07:22', '1.2962636053632015', '103.80532130599022', '-1', 'non-core'], ['2016-03-14 07:23', '1.2932369947481046', '103.8084176927805', '-1', 'non-core'], ['2016-03-14 07:24', '1.29078180774499', '103.81220812350512', '-1', 'non-core'], ['2016-03-14 07:25', '1.2881611487344113', '103.81658770143986', '-1', 'non-core'], ['2016-03-14 07:26', '1.288461144678111', '103.82171373814344', '-1', 'non-core'], ['2016-03-14 07:29', '1.2820405467287337', '103.83914541453123', '1', 'non-core'], ['2016-03-14 07:30', '1.2827013217161618', '103.83687280118465', '-1', 'non-core'], ['2016-03-14 07:31', '1.2786948784713894', '103.84327869862318', '1', 'core']]

    #route_lst = [['2016-03-18 08:17', '1.3880628382205689', '103.85337347963026', '0', 'core'], ['2016-03-18 08:18', '1.3775774335033717', '103.85768260806799', '-1', 'non-core'], ['2016-03-18 08:19', '1.371398836908549', '103.86183924973011', '-1', 'non-core'], ['2016-03-18 08:20', '1.3620945621542', '103.8593826815486', '-1', 'non-core'], ['2016-03-18 08:21', '1.356866841193967', '103.85880779474974', '-1', 'non-core'], ['2016-03-18 08:22', '1.35106371769912', '103.85669510811567', '-1', 'non-core'], ['2016-03-18 08:23', '1.3549971528584457', '103.85901079326868', '-1', 'non-core'], ['2016-03-18 08:29', '1.3497891284453034', '103.84280394762754', '-1', 'non-core'], ['2016-03-18 08:30', '1.3482985904395632', '103.84318482130766', '-1', 'non-core'], ['2016-03-18 08:31', '1.3550765232662236', '103.84150441735983', '-1', 'non-core'], ['2016-03-18 08:32', '1.3503160666946463', '103.8407179553594', '-1', 'non-core'], ['2016-03-18 08:33', '1.3476797060365975', '103.83887853473425', '-1', 'non-core'], ['2016-03-18 08:34', '1.3447697521571662', '103.8376303575933', '-1', 'non-core'], ['2016-03-18 08:37', '1.3372303647733037', '103.81924498826265', '-1', 'non-core'], ['2016-03-18 08:38', '1.32480735596099', '103.81489539518952', '-1', 'non-core'], ['2016-03-18 08:39', '1.3196439158851598', '103.81351771205664', '-1', 'non-core'], ['2016-03-18 08:40', '1.3143761049599896', '103.80380988121033', '-1', 'non-core'], ['2016-03-18 08:41', '1.308331992741845', '103.80167338997126', '-1', 'non-core'], ['2016-03-18 08:42', '1.302714668149009', '103.80193818360567', '-1', 'non-core'], ['2016-03-18 08:43', '1.3001457758586572', '103.79947330802679', '-1', 'non-core'], ['2016-03-18 08:44', '1.2965489645218338', '103.79940245300531', '-1', 'non-core'], ['2016-03-18 08:45', '1.2903948617861454', '103.80093240941113', '1', 'non-core'], ['2016-03-18 08:46', '1.2947961422001606', '103.80497004836798', '1', 'non-core'], ['2016-03-18 08:47', '1.289220183955125', '103.80443997681141', '1', 'core']]

    #route_lst = [['2016-03-14 12:01', '1.3898775863695354', '103.85576706379652', '0', 'core'], ['2016-03-14 12:03', '1.3633832185081631', '103.85932317003608', '-1', 'non-core'], ['2016-03-14 12:04', '1.347962766140173', '103.85969616472721', '-1', 'non-core'], ['2016-03-14 12:05', '1.3398783498677918', '103.86001098901033', '-1', 'non-core'], ['2016-03-14 12:06', '1.3443944588189953', '103.86783499270678', '-1', 'non-core'], ['2016-03-14 12:07', '1.3202721904806627', '103.85644347220659', '-1', 'non-core'], ['2016-03-14 12:08', '1.314231306994999', '103.84620152413845', '-1', 'non-core'], ['2016-03-14 12:09', '1.3047074829731766', '103.84308222681284', '-1', 'non-core'], ['2016-03-14 12:11', '1.2779786841891019', '103.8392647728324', '-1', 'non-core'], ['2016-03-14 12:12', '1.2803039153430866', '103.83615408092737', '-1', 'non-core'], ['2016-03-14 12:13', '1.277625052946498', '103.82928913459182', '-1', 'non-core'], ['2016-03-14 12:14', '1.2808673737679876', '103.82347863167524', '-1', 'non-core'], ['2016-03-14 12:16', '1.2718185050904263', '103.82114510983229', '1', 'non-core'], ['2016-03-14 12:17', '1.2693715911810888', '103.82284495979548', '1', 'non-core'], ['2016-03-14 12:18', '1.2660826646397687', '103.82673047482967', '-1', 'non-core'], ['2016-03-14 12:19', '1.2694687972152665', '103.82518719881773', '-1', 'non-core'], ['2016-03-14 12:21', '1.2659342791961858', '103.82406245917082', '1', 'non-core'], ['2016-03-14 12:22', '1.2562728529154779', '103.82206879556179', '1', 'core']]
    #route_lst = [['2016-03-14 12:01:01', '1.3890275762664057', '103.85666694492102'], ['2016-03-14 12:01:12', '1.3890275762664057', '103.85666694492102'], ['2016-03-14 12:01:12', '1.3907275964726649', '103.85486718267202'], ['2016-03-14 12:01:16', '1.3907275964726649', '103.85486718267202'], ['2016-03-14 12:03:17', '1.367787946752678', '103.85920096188784'], ['2016-03-14 12:03:18', '1.3665196230428185', '103.8586363568902'], ['2016-03-14 12:03:18', '1.367787946752678', '103.85920096188784'], ['2016-03-14 12:03:23', '1.3621823799289676', '103.8587087765336'], ['2016-03-14 12:03:23', '1.3665196230428185', '103.8586363568902'], ['2016-03-14 12:03:23', '1.3669727874050908', '103.85962944477797'], ['2016-03-14 12:03:33', '1.3650086276432796', '103.86028792709112'], ['2016-03-14 12:03:33', '1.3621823799289676', '103.8587087765336'], ['2016-03-14 12:03:46', '1.3650086276432796', '103.86028792709112'], ['2016-03-14 12:03:53', '1.3594727721527284', '103.8585364446044'], ['2016-03-14 12:03:54', '1.3516831356519226', '103.86150766164064'], ['2016-03-14 12:03:54', '1.3594727721527284', '103.8585364446044'], ['2016-03-14 12:04:04', '1.3516831356519226', '103.86150766164064'], ['2016-03-14 12:04:15', '1.354231864569166', '103.85561283677816'], ['2016-03-14 12:04:23', '1.3469650975283396', '103.85969381779432'], ['2016-03-14 12:04:23', '1.354231864569166', '103.85561283677816'], ['2016-03-14 12:04:33', '1.3469650975283396', '103.85969381779432'], ['2016-03-14 12:04:44', '1.347332458597223', '103.85515753179789'], ['2016-03-14 12:04:44', '1.3411463053386132', '103.86514540761709'], ['2016-03-14 12:04:54', '1.3411463053386132', '103.86514540761709'], ['2016-03-14 12:05:23', '1.3413098752622405', '103.86012967675924'], ['2016-03-14 12:05:28', '1.3419507474806474', '103.85902795940638'], ['2016-03-14 12:05:28', '1.3413098752622405', '103.86012967675924'], ['2016-03-14 12:05:41', '1.337040964825798', '103.86043343693018'], ['2016-03-14 12:05:41', '1.3419507474806474', '103.85902795940638'], ['2016-03-14 12:05:42', '1.337040964825798', '103.86043343693018'], ['2016-03-14 12:05:42', '1.3385452739371702', '103.86089477688074'], ['2016-03-14 12:06:00', '1.3473190512599076', '103.8713051006198'], ['2016-03-14 12:06:00', '1.3385452739371702', '103.86089477688074'], ['2016-03-14 12:06:03', '1.3473190512599076', '103.8713051006198'], ['2016-03-14 12:07:21', '1.3221010607404589', '103.85775994509459'], ['2016-03-14 12:07:24', '1.3183563501975888', '103.85612782090902'], ['2016-03-14 12:07:24', '1.3221010607404589', '103.85775994509459'], ['2016-03-14 12:07:30', '1.3183563501975888', '103.85612782090902'], ['2016-03-14 12:07:30', '1.317138949351338', '103.85568927973509'], ['2016-03-14 12:07:31', '1.320819305815499', '103.85715376585722'], ['2016-03-14 12:07:31', '1.317138949351338', '103.85568927973509'], ['2016-03-14 12:07:33', '1.320819305815499', '103.85715376585722'], ['2016-03-14 12:07:33', '1.3210163957894625', '103.85754939168692'], ['2016-03-14 12:07:35', '1.3194490608026421', '103.85724429041147'], ['2016-03-14 12:07:35', '1.3210163957894625', '103.85754939168692'], ['2016-03-14 12:07:36', '1.322425521610258', '103.85764997452497'], ['2016-03-14 12:07:36', '1.3194490608026421', '103.85724429041147'], ['2016-03-14 12:07:39', '1.322425521610258', '103.85764997452497'], ['2016-03-14 12:07:54', '1.3214695685954458', '103.84830314666033'], ['2016-03-14 12:08:06', '1.3172207351096514', '103.84834874421358'], ['2016-03-14 12:08:11', '1.315284691192887', '103.84711157530546'], ['2016-03-14 12:08:11', '1.3172207351096514', '103.84834874421358'], ['2016-03-14 12:08:14', '1.3132038445328635', '103.84725105017424'], ['2016-03-14 12:08:14', '1.315284691192887', '103.84711157530546'], ['2016-03-14 12:08:19', '1.3132038445328635', '103.84725105017424'], ['2016-03-14 12:08:19', '1.3135591438597796', '103.84454671293497'], ['2016-03-14 12:08:34', '1.3135591438597796', '103.84454671293497'], ['2016-03-14 12:08:36', '1.313391549843944', '103.84483303874731'], ['2016-03-14 12:08:48', '1.313391549843944', '103.84483303874731'], ['2016-03-14 12:08:48', '1.3127278774308682', '103.84511802345514'], ['2016-03-14 12:08:49', '1.3127278774308682', '103.84511802345514'], ['2016-03-14 12:09:35', '1.3047074829731766', '103.84308222681284'], ['2016-03-14 12:09:40', '1.3047074829731766', '103.84308222681284'], ['2016-03-14 12:11:32', '1.2791538698957698', '103.83556198328733'], ['2016-03-14 12:11:32', '1.2768034984824337', '103.84296756237745'], ['2016-03-14 12:12:24', '1.2797625795401757', '103.84029272943735'], ['2016-03-14 12:12:25', '1.2805549744775784', '103.83223939687014'], ['2016-03-14 12:12:26', '1.2805549744775784', '103.83223939687014'], ['2016-03-14 12:12:47', '1.2803431328770143', '103.83984480053186'], ['2016-03-14 12:13:06', '1.278334659111155', '103.83041750639677'], ['2016-03-14 12:13:12', '1.2708598514386835', '103.82572297006845'], ['2016-03-14 12:13:12', '1.278334659111155', '103.83041750639677'], ['2016-03-14 12:13:19', '1.2708598514386835', '103.82572297006845'], ['2016-03-14 12:13:35', '1.280222463603054', '103.82589597254992'], ['2016-03-14 12:13:40', '1.281083237633099', '103.83512008935213'], ['2016-03-14 12:13:40', '1.280222463603054', '103.82589597254992'], ['2016-03-14 12:13:49', '1.281083237633099', '103.83512008935213'], ['2016-03-14 12:14:29', '1.2808673737679876', '103.82347863167524'], ['2016-03-14 12:14:43', '1.2808673737679876', '103.82347863167524'], ['2016-03-14 12:16:15', '1.2719619679416827', '103.82365297526121'], ['2016-03-14 12:16:18', '1.2721604024931787', '103.82265452295542'], ['2016-03-14 12:16:18', '1.2719619679416827', '103.82365297526121'], ['2016-03-14 12:16:26', '1.2713331448364182', '103.81712783128023'], ['2016-03-14 12:16:26', '1.2721604024931787', '103.82265452295542'], ['2016-03-14 12:16:29', '1.2713331448364182', '103.81712783128023'], ['2016-03-14 12:17:18', '1.2693715911810888', '103.82284495979548'], ['2016-03-14 12:17:28', '1.2693715911810888', '103.82284495979548'], ['2016-03-14 12:18:14', '1.262545694662681', '103.82865060120821'], ['2016-03-14 12:18:24', '1.262545694662681', '103.82865060120821'], ['2016-03-14 12:18:35', '1.2696196346168565', '103.82481034845114'], ['2016-03-14 12:18:46', '1.2696196346168565', '103.82481034845114'], ['2016-03-14 12:19:37', '1.2685041093564244', '103.8246326521039'], ['2016-03-14 12:19:46', '1.2704334850741088', '103.82574174553156'], ['2016-03-14 12:19:46', '1.2685041093564244', '103.8246326521039'], ['2016-03-14 12:19:51', '1.2704334850741088', '103.82574174553156'], ['2016-03-14 12:21:23', '1.2706372828420558', '103.82532265037298'], ['2016-03-14 12:21:24', '1.2706372828420558', '103.82532265037298'], ['2016-03-14 12:21:47', '1.2565282719044462', '103.82154207676649'], ['2016-03-14 12:22:18', '1.2561729646453157', '103.82202822715044'], ['2016-03-14 12:22:29', '1.2561729646453157', '103.82202822715044'], ['2016-03-14 12:22:42', '1.2563727411856398', '103.82210936397314'], ['2016-03-14 12:22:53', '1.2563727411856398', '103.82210936397314']]

    #route_lst = [['2016-03-14 08:05', '1.326076373842918', '103.88820771127939', '0', 'core'], ['2016-03-14 08:27', '1.333058516891971', '103.90173990279436', '-1', 'non-core'], ['2016-03-14 08:34', '1.3365283550264948', '103.90416484326124', '-1', 'non-core'], ['2016-03-14 08:35', '1.3375115642993407', '103.90389528125525', '1', 'non-core'], ['2016-03-14 09:29', '1.3374043051680085', '103.90034403651953', '1', 'non-core'], ['2016-03-14 09:30', '1.3374043051680085', '103.90034403651953', '1', 'non-core'], ['2016-03-14 09:47', '1.3376804974216714', '103.9022933319211', '1', 'core']]
    
    #route_lst = [['2016-03-17 08:23', '1.3660302590644666', '103.83713375777006', '0', 'core'], ['2016-03-17 08:24', '1.3636649102432274', '103.83770867895622', '0', 'non-core'], ['2016-03-17 08:25', '1.3616751385734631', '103.84188372641802', '-1', 'non-core'], ['2016-03-17 08:26', '1.362341120493176', '103.84637356549501', '3', 'non-core'], ['2016-03-17 08:27', '1.3649724280967521', '103.8438218459487', '3', 'non-core'], ['2016-03-17 08:28', '1.3631637908016456', '103.84718131273985', '3', 'non-core'], ['2016-03-17 08:30', '1.361412803363829', '103.85127771645784', '3', 'non-core'], ['2016-03-17 08:31', '1.3611670035883916', '103.85265994817019', '-1', 'non-core'], ['2016-03-17 08:32', '1.353987175011065', '103.8551945798099', '-1', 'non-core'], ['2016-03-17 08:33', '1.3533510048417057', '103.86210847645998', '1', 'core']]

    print("Length of route: " + str(len(route_lst)))
    #process("lat_long_kdtree.pickle", "descriptions_list.pickle", route, "query", 3)
    query_kdtree_output = process("lat_long_kdtree.pickle", "descriptions_list.pickle", route_lst, "query_ballpoint", 0.0025) #stores a list of tuples
    sorted_description_counts = query_kdtree_output[0]
    print(query_kdtree_output)
    print("------")
    classified = classify_descriptions(sorted_description_counts)
    keyword_tags = list(flatten(classified[:4]))
    print(keyword_tags)
    print(query_kdtree_output[1])
    print(query_kdtree_output[2])
    traffic_infrastructure_by_time = get_infrastructure_by_time(keyword_tags, query_kdtree_output[1], query_kdtree_output[2])
    for i in traffic_infrastructure_by_time:
        print(i)

    print("------")
    for i in range(len(classified)-1):
        print(classified[i])
        print("------")
    # for x in classified[4]:
    #     while True:
    #         try:
    #             print(x)
    #             break
    #         except:
    #             print(x[0].encode('utf-8'))
    #             print(x[1])
    #             break
    # for tup in sorted_description_counts:
    #     # if identify_mrt_lrt_stations(tup[0]):
    #     #     print(tup)
    #     # elif identify_mrt_lrt_lines(tup[0]):
    #     #     print(tup)
    #     # if identify_bus_numbers(tup[0]):
    #     #     print(tup)
    #     if identify_expressways(tup[0]):
    #         print(tup)
